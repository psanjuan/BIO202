<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />


<meta name="author" content="Tad &amp; Anna Rasmussen" />


<title>Dealing with heterogeneity</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />

</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}

.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->




<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = false;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
  padding-left: 25px;
  text-indent: 0;
}

.tocify .list-group-item {
  border-radius: 0px;
}

.tocify-subheader {
  display: inline;
}
.tocify-subheader .tocify-item {
  font-size: 0.95em;
}

</style>

<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html"></a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="00-computer-setup.html">Computer Setup</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    W1
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="01-A-R-intro.html">Intro to R</a>
    </li>
    <li>
      <a href="01-B-Rmarkdown-intro.html">R markdown</a>
    </li>
    <li>
      <a href="01-C-R-workshop.html">R workshop</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    W2
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="02-A-tidyr.html">ggplot2 and tidyr</a>
    </li>
    <li>
      <a href="02-B-git-intro.html">Intro to git</a>
    </li>
    <li>
      <a href="02-C-student-projects.html">Project introductions</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    W3
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="03-A-data-exploration.html">Data exploration</a>
    </li>
    <li>
      <a href="03-B-linear-models.html">Linear models</a>
    </li>
    <li>
      <a href="03-C-heterogeneity.html">Heterogeneity</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    W4
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="04-A-mixed-models.html">Mixed effects models</a>
    </li>
    <li>
      <a href="04-B-binary-data.html">Binary &amp; proportional data</a>
    </li>
    <li>
      <a href="04-C-zero-data.html">Zero-inflated data</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    W5
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="05-A-Bayesian-linear-models.html">Bayesian linear models</a>
    </li>
    <li>
      <a href="05-B-Bayesian-priors.html">Bayesian inference with prior information</a>
    </li>
    <li>
      <a href="05-C-Advanced-bayesian-example.html">Advanced Bayesian model example</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    W6
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="06-A-unconstrained-ordination.html">Unconstrained ordination</a>
    </li>
    <li>
      <a href="06-B-constrained-ordination.html">Constrained ordination</a>
    </li>
    <li>
      <a href="06-C-matrix-comparison.html">Comparing multivariate data</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    W8
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="08-A-mapping.html">Visualizing spatial data</a>
    </li>
    <li>
      <a href="08-B-spatial-regression.html">Spatial regression</a>
    </li>
    <li>
      <a href="08-C-spatial-ordination.html">Ordination approach to spatial analysis</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    W9
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="09-A-time-series.html">Time series</a>
    </li>
    <li>
      <a href="09-B-networks.html">Network analysis</a>
    </li>
    <li>
      <a href="09-C-occupancy-models.html">Occupancy models</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Dealing with heterogeneity</h1>
<h4 class="author"><em>Tad &amp; Anna Rasmussen</em></h4>

</div>


<p><strong>Assigned Reading:</strong></p>
<blockquote>
<p>Chapter 4 from: Zuur, A. F., Ieno, E. N., Walker, N., Saveliev, A. A. and Smith, G. M. 2009. <em>Mixed Effects Models and Extensions in Ecology with R.</em> Springer. <a href="https://link-springer-com.stanford.idm.oclc.org/book/10.1007%2F978-0-387-87458-6">link</a></p>
</blockquote>
<div id="key-points" class="section level3">
<h3>Key Points</h3>
<div id="from-chapter-2" class="section level4">
<h4>From Chapter 2</h4>
<p>“In none of these [35] real data sets could we find a non-trivial example for a linear regression model for which all assumptions held.”</p>
</div>
<div id="heterogeneity" class="section level4">
<h4>Heterogeneity</h4>
<ul>
<li><p>One frequently violated assumption = homogeneity, i.e., that residuals are normally distributed with a mean of 0 and a fixed variace, Ïƒ2:</p>
<ul>
<li><span class="math inline">\(Y_i = \alpha + \beta_1 X_{1i} + \beta_2 X_{2i} + \epsilon_i\)</span></li>
<li><span class="math inline">\(\epsilon_i \sim N(0, \sigma^2)\)</span></li>
</ul></li>
<li><p>How to check for homogeneity</p>
<p>Residuals vs. fitted values (Fig 4.2a)</p></li>
<li><p>How to identify source of variation in residuals</p>
<p>Residuals vs. explanatory variables (Fig. 4.2b, c)</p></li>
</ul>
</div>
<div id="many-variance-structures-table-4.1" class="section level4">
<h4>Many variance structures (Table 4.1)</h4>
<ul>
<li><code>V1&lt;-varFixed(âˆ¼DML)</code>
<ul>
<li><span class="math inline">\(\epsilon_i \sim N(0, \sigma^2 \times \mathrm{DML}_i) \ \ i = 1, \ldots, 768\)</span></li>
</ul></li>
<li><code>V1&lt;-varIdent(form= âˆ¼ 1 | fMONTH)</code>
<ul>
<li><span class="math inline">\(\epsilon_{ij} \sim N(0, \sigma_j^{2}) \ \ j = 1, \ldots, 12\)</span></li>
</ul></li>
<li><code>V1&lt;-varPower(form =âˆ¼ DML)</code>
<ul>
<li><span class="math inline">\(\epsilon_{ij} \sim N(0, \sigma^2 \times |\mathrm{DML}_i|^{2\delta})\)</span></li>
</ul></li>
<li><code>V1&lt;-varPower(form =âˆ¼ DML | fMONTH)</code>
<ul>
<li><span class="math inline">\(\epsilon_{ij} \sim N(0, \sigma^2 \times |\mathrm{DML}_{ij}|^{2\delta_j})\)</span></li>
</ul></li>
<li><code>V1&lt;-varExp(form =âˆ¼ DML)</code>
<ul>
<li><span class="math inline">\(\epsilon_{ij} \sim N(0, \sigma^2 \times e^{2 \delta \times \mathrm{DML}_{ij}})\)</span></li>
</ul></li>
<li><code>V1&lt;-varConstPower(form =âˆ¼ DML)</code>
<ul>
<li><span class="math inline">\(\epsilon_{ij} \sim N(0, \sigma^2 \times (\delta_1 + |\mathrm{DML}_{ij}|^{\delta_2})^2)\)</span></li>
</ul></li>
<li><code>V1&lt;-varComb(varIdent(form =âˆ¼ 1 | fMONTH), varExp(form =âˆ¼ DML))</code>
<ul>
<li><span class="math inline">\(\epsilon_{ij} \sim N(0, \sigma^2_j \times e^{2 \delta \times \mathrm{DML}_{ij}})\)</span></li>
</ul></li>
</ul>
<p>How to choose variance structure? - AIC, e.g., <code>AIC(M.lm, M.gls1, M.gls2)</code></p>
</div>
<div id="suggested-protocol" class="section level4">
<h4>Suggested protocol</h4>
<ol style="list-style-type: decimal">
<li>Fit a full model</li>
<li>Plot standardized residuals vs. each predictor
<ul>
<li>If variance shows a relationship with any predictor, re-fit model with a modified variance structure.</li>
</ul></li>
<li>Compare models using AIC or LR test
<ul>
<li>If better, extract standardized residuals, plot against other factors, and continue to modify variance structure.</li>
</ul></li>
<li>Remove non-significant terms from fixed effects, re-examine residual plots (iterative process)</li>
<li>Interpret</li>
</ol>
<hr />
</div>
</div>
<div id="analysis-example" class="section level3">
<h3>Analysis Example</h3>
<p>Random/explanatory variables are heterskedastic if there are sub-populations that have different variabilities from others.“Variability” could be quantified by the variance or other measures of statistical dispersion.</p>
<p>Why is it a problem in regression??</p>
<p>Want models that consistantly predict response variable across different values of the explanatory variable. So if you plot residuals (the difference between modeled and actual data) the residuals should be uniform across the explanatory variable. If not, then this indicates heterogeneity/ heteroskedasticity. Modeling errors are assumed to be uncorrelated and uniform in tests so heterskedasticity is a problem.</p>
<p>Code and data from <em>Mixed Effects Models and Extensions in Ecology with R</em> (2009) Zuur, Ieno, Walker, Saveliev and Smith. <em>Springer</em> available at <a href="www.highstat.com">highstat.com</a></p>
<div id="example-1-squid-testis-weight-v.-dorsal-mantle-length" class="section level4">
<h4>Example 1: Squid testis weight v. dorsal mantle length</h4>
<p>Load the data, relevant code, and libraries.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Read in files from local copies on your computer</span>
Squid &lt;-<span class="st"> </span><span class="kw">read.table</span>(<span class="dt">file =</span> <span class="st">&quot;data/Squid.txt&quot;</span>, <span class="dt">header =</span> <span class="ot">TRUE</span>, <span class="dt">dec=</span><span class="st">&quot;.&quot;</span>) 
<span class="kw">source</span>(<span class="st">&quot;code/HighstatLibV10.R&quot;</span>)

<span class="co"># If you do not have these files on your computer use:</span>
Squid &lt;-<span class="st"> </span><span class="kw">read.table</span>(<span class="st">&quot;https://raw.githubusercontent.com/fukamilab/BIO202/master/data/Squid.txt&quot;</span>, <span class="dt">header =</span> T)
<span class="kw">source</span>(<span class="st">&quot;https://raw.githubusercontent.com/fukamilab/BIO202/master/code/HighstatLibV10.R&quot;</span>)</code></pre></div>
<p>A good first step is to investigate structure of the Squid data set.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str</span>(Squid)</code></pre></div>
<pre><code>## &#39;data.frame&#39;:    768 obs. of  6 variables:
##  $ Specimen    : int  1017 1034 1070 1070 1019 1002 1001 1013 1002 1006 ...
##  $ YEAR        : int  1991 1990 1990 1990 1990 1990 1991 1990 1990 1990 ...
##  $ MONTH       : int  2 9 12 11 8 10 5 7 7 7 ...
##  $ DML         : int  136 144 108 130 121 117 133 105 109 97 ...
##  $ Testisweight: num  0.006 0.008 0.008 0.011 0.012 0.012 0.013 0.015 0.017 0.017 ...
##  $ fMONTH      : Factor w/ 12 levels &quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,..: 2 9 12 11 8 10 5 7 7 7 ...</code></pre>
<p>Then, inspect residuals across explanatory variables. The variability along the explanatory variable should be consistant. Look out for cone shapes!</p>
<p><img src="images/03-C/unnamed-chunk-5-1.png" width="672" /></p>
<p>Looks like we have cones, our data is hetergeneous/heteroskedastic. Now it’s time to investigate variance covariates. There are several possible types of relationships between variance and covariates.</p>
<table>
<thead>
<tr class="header">
<th align="left">R function</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">VarFixed</td>
<td align="left">Fixed variance</td>
</tr>
<tr class="even">
<td align="left">VarIdent</td>
<td align="left">Different variances per stratum</td>
</tr>
<tr class="odd">
<td align="left">VarPower</td>
<td align="left">Power of the variance covariate</td>
</tr>
<tr class="even">
<td align="left">VarExp</td>
<td align="left">Exponential of the variance covariate</td>
</tr>
<tr class="odd">
<td align="left">VarConstPower</td>
<td align="left">Constant plus power of the variance covariate</td>
</tr>
<tr class="even">
<td align="left">VarComb</td>
<td align="left">A combination of variance functions</td>
</tr>
</tbody>
</table>
<p>Let’s start with a simple linear model and GLS (generalized least squares) model with fixed variance along DML (variance that is proportional to DML).</p>
<p>*Note unweighted gls is just a lm</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(nlme)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">M.lm&lt;-<span class="kw">gls</span>(Testisweight~DML*fMONTH,<span class="dt">data=</span>Squid)
vf1Fixed&lt;-<span class="kw">varFixed</span>(~DML)
M.gls1&lt;-<span class="kw">gls</span>(Testisweight~DML*fMONTH,
              <span class="dt">weights=</span>vf1Fixed,<span class="dt">data=</span>Squid)
<span class="kw">anova</span>(M.lm,M.gls1)</code></pre></div>
<pre><code>##        Model df      AIC      BIC    logLik
## M.lm       1 25 3752.084 3867.385 -1851.042
## M.gls1     2 25 3620.898 3736.199 -1785.449</code></pre>
<p>Now allow for different variance for each month</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">vf2 &lt;-<span class="st"> </span><span class="kw">varIdent</span>(<span class="dt">form=</span> ~<span class="st"> </span><span class="dv">1</span>|fMONTH)
M.gls2 &lt;-<span class="st"> </span><span class="kw">gls</span>(Testisweight ~<span class="st"> </span>DML*fMONTH,
              <span class="dt">weights=</span>vf2, <span class="dt">data =</span>Squid)
<span class="kw">anova</span>(M.lm,M.gls1,M.gls2)</code></pre></div>
<pre><code>##        Model df      AIC      BIC    logLik   Test  L.Ratio p-value
## M.lm       1 25 3752.084 3867.385 -1851.042                        
## M.gls1     2 25 3620.898 3736.199 -1785.449                        
## M.gls2     3 36 3614.436 3780.469 -1771.218 2 vs 3 28.46161  0.0027</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">anova</span>(M.lm,M.gls2)</code></pre></div>
<pre><code>##        Model df      AIC      BIC    logLik   Test  L.Ratio p-value
## M.lm       1 25 3752.084 3867.385 -1851.042                        
## M.gls2     2 36 3614.436 3780.469 -1771.218 1 vs 2 159.6479  &lt;.0001</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(M.gls2)</code></pre></div>
<pre><code>## Generalized least squares fit by REML
##   Model: Testisweight ~ DML * fMONTH 
##   Data: Squid 
##        AIC      BIC    logLik
##   3614.436 3780.469 -1771.218
## 
## Variance function:
##  Structure: Different standard deviations per stratum
##  Formula: ~1 | fMONTH 
##  Parameter estimates:
##         2         9        12        11         8        10         5 
## 1.0000000 2.9913588 1.2736165 1.5090471 0.9821378 2.2162169 1.6396315 
##         7         6         4         1         3 
## 1.3783514 1.6473098 1.4232366 1.9584902 1.9788666 
## 
## Coefficients:
##                   Value Std.Error   t-value p-value
## (Intercept)    3.215222 1.8341071  1.753017  0.0800
## DML            0.021157 0.0054400  3.889175  0.0001
## fMONTH2       -6.720020 1.9597221 -3.429068  0.0006
## fMONTH3       -3.926923 2.1674222 -1.811794  0.0704
## fMONTH4       -4.772045 2.0577397 -2.319071  0.0207
## fMONTH5       -2.771457 2.1100343 -1.313466  0.1894
## fMONTH6       -9.598061 2.2226968 -4.318205  0.0000
## fMONTH7       -7.494959 2.0476376 -3.660295  0.0003
## fMONTH8       -7.479426 2.1418112 -3.492103  0.0005
## fMONTH9      -14.963009 2.1846006 -6.849311  0.0000
## fMONTH10     -12.320827 1.9458121 -6.331972  0.0000
## fMONTH11     -12.650490 2.0247519 -6.247921  0.0000
## fMONTH12      -9.235813 1.9872672 -4.647494  0.0000
## DML:fMONTH2    0.018032 0.0062548  2.882916  0.0041
## DML:fMONTH3    0.003151 0.0067435  0.467309  0.6404
## DML:fMONTH4    0.002972 0.0064731  0.459058  0.6463
## DML:fMONTH5   -0.008677 0.0066347 -1.307773  0.1914
## DML:fMONTH6    0.017620 0.0075283  2.340566  0.0195
## DML:fMONTH7    0.004647 0.0067263  0.690912  0.4898
## DML:fMONTH8    0.000500 0.0069997  0.071447  0.9431
## DML:fMONTH9    0.044242 0.0068417  6.466483  0.0000
## DML:fMONTH10   0.039495 0.0059475  6.640523  0.0000
## DML:fMONTH11   0.046671 0.0066109  7.059729  0.0000
## DML:fMONTH12   0.034099 0.0064115  5.318337  0.0000
## 
##  Correlation: 
##              (Intr) DML    fMONTH2 fMONTH3 fMONTH4 fMONTH5 fMONTH6 fMONTH7
## DML          -0.979                                                       
## fMONTH2      -0.936  0.916                                                
## fMONTH3      -0.846  0.829  0.792                                         
## fMONTH4      -0.891  0.873  0.834   0.754                                 
## fMONTH5      -0.869  0.851  0.814   0.736   0.775                         
## fMONTH6      -0.825  0.808  0.772   0.698   0.735   0.717                 
## fMONTH7      -0.896  0.877  0.838   0.758   0.798   0.779   0.739         
## fMONTH8      -0.856  0.839  0.801   0.725   0.763   0.744   0.707   0.767 
## fMONTH9      -0.840  0.822  0.786   0.710   0.748   0.730   0.693   0.752 
## fMONTH10     -0.943  0.923  0.882   0.798   0.840   0.819   0.778   0.844 
## fMONTH11     -0.906  0.887  0.848   0.767   0.807   0.787   0.747   0.811 
## fMONTH12     -0.923  0.904  0.864   0.781   0.823   0.802   0.762   0.827 
## DML:fMONTH2   0.852 -0.870 -0.962  -0.721  -0.759  -0.740  -0.703  -0.763 
## DML:fMONTH3   0.790 -0.807 -0.739  -0.973  -0.704  -0.687  -0.652  -0.708 
## DML:fMONTH4   0.823 -0.840 -0.770  -0.696  -0.969  -0.715  -0.679  -0.737 
## DML:fMONTH5   0.803 -0.820 -0.751  -0.679  -0.716  -0.966  -0.663  -0.719 
## DML:fMONTH6   0.708 -0.723 -0.662  -0.599  -0.631  -0.615  -0.960  -0.634 
## DML:fMONTH7   0.792 -0.809 -0.741  -0.670  -0.706  -0.688  -0.654  -0.957 
## DML:fMONTH8   0.761 -0.777 -0.712  -0.644  -0.678  -0.662  -0.628  -0.682 
## DML:fMONTH9   0.779 -0.795 -0.729  -0.659  -0.694  -0.677  -0.642  -0.697 
## DML:fMONTH10  0.896 -0.915 -0.838  -0.758  -0.798  -0.779  -0.739  -0.802 
## DML:fMONTH11  0.806 -0.823 -0.754  -0.682  -0.718  -0.700  -0.665  -0.722 
## DML:fMONTH12  0.831 -0.848 -0.778  -0.703  -0.741  -0.722  -0.686  -0.744 
##              fMONTH8 fMONTH9 fMONTH10 fMONTH11 fMONTH12 DML:MONTH2
## DML                                                               
## fMONTH2                                                           
## fMONTH3                                                           
## fMONTH4                                                           
## fMONTH5                                                           
## fMONTH6                                                           
## fMONTH7                                                           
## fMONTH8                                                           
## fMONTH9       0.719                                               
## fMONTH10      0.807   0.791                                       
## fMONTH11      0.776   0.761   0.854                               
## fMONTH12      0.790   0.775   0.870    0.836                      
## DML:fMONTH2  -0.729  -0.715  -0.803   -0.771   -0.786             
## DML:fMONTH3  -0.676  -0.663  -0.745   -0.716   -0.729    0.702    
## DML:fMONTH4  -0.705  -0.691  -0.776   -0.745   -0.760    0.731    
## DML:fMONTH5  -0.688  -0.674  -0.757   -0.727   -0.741    0.713    
## DML:fMONTH6  -0.606  -0.594  -0.667   -0.641   -0.653    0.628    
## DML:fMONTH7  -0.678  -0.665  -0.747   -0.717   -0.731    0.703    
## DML:fMONTH8  -0.973  -0.639  -0.717   -0.689   -0.702    0.676    
## DML:fMONTH9  -0.667  -0.970  -0.734   -0.705   -0.719    0.692    
## DML:fMONTH10 -0.767  -0.752  -0.969   -0.811   -0.827    0.796    
## DML:fMONTH11 -0.690  -0.677  -0.760   -0.964   -0.744    0.716    
## DML:fMONTH12 -0.711  -0.698  -0.783   -0.753   -0.961    0.738    
##              DML:MONTH3 DML:MONTH4 DML:MONTH5 DML:MONTH6 DML:MONTH7
## DML                                                                
## fMONTH2                                                            
## fMONTH3                                                            
## fMONTH4                                                            
## fMONTH5                                                            
## fMONTH6                                                            
## fMONTH7                                                            
## fMONTH8                                                            
## fMONTH9                                                            
## fMONTH10                                                           
## fMONTH11                                                           
## fMONTH12                                                           
## DML:fMONTH2                                                        
## DML:fMONTH3                                                        
## DML:fMONTH4   0.678                                                
## DML:fMONTH5   0.661      0.689                                     
## DML:fMONTH6   0.583      0.607      0.592                          
## DML:fMONTH7   0.652      0.680      0.663      0.584               
## DML:fMONTH8   0.627      0.653      0.637      0.562      0.629    
## DML:fMONTH9   0.641      0.668      0.652      0.575      0.643    
## DML:fMONTH10  0.738      0.769      0.750      0.661      0.740    
## DML:fMONTH11  0.664      0.692      0.675      0.595      0.666    
## DML:fMONTH12  0.684      0.713      0.696      0.613      0.686    
##              DML:MONTH8 DML:MONTH9 DML:MONTH10 DML:MONTH11
## DML                                                       
## fMONTH2                                                   
## fMONTH3                                                   
## fMONTH4                                                   
## fMONTH5                                                   
## fMONTH6                                                   
## fMONTH7                                                   
## fMONTH8                                                   
## fMONTH9                                                   
## fMONTH10                                                  
## fMONTH11                                                  
## fMONTH12                                                  
## DML:fMONTH2                                               
## DML:fMONTH3                                               
## DML:fMONTH4                                               
## DML:fMONTH5                                               
## DML:fMONTH6                                               
## DML:fMONTH7                                               
## DML:fMONTH8                                               
## DML:fMONTH9   0.618                                       
## DML:fMONTH10  0.711      0.727                            
## DML:fMONTH11  0.640      0.654      0.753                 
## DML:fMONTH12  0.659      0.675      0.776       0.698     
## 
## Standardized residuals:
##         Min          Q1         Med          Q3         Max 
## -3.81345785 -0.59501560 -0.03602982  0.63482429  4.28871347 
## 
## Residual standard error: 1.273373 
## Degrees of freedom: 768 total; 744 residual</code></pre>
<p>Let’s look at the residuals across months to further investigate. Graphs yay!</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(lattice)

E &lt;-<span class="st"> </span><span class="kw">resid</span>(M.lm)
<span class="kw">coplot</span>(E~DML|fMONTH,<span class="dt">data=</span>Squid)</code></pre></div>
<p><img src="images/03-C/unnamed-chunk-12-1.png" width="672" /></p>
<p>Now, let’s look at all the different types of variance-covariate relationships</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">vf3 &lt;-<span class="st"> </span><span class="kw">varPower</span>(<span class="dt">form =</span>~<span class="st"> </span>DML)
M.gls3 &lt;-<span class="st"> </span><span class="kw">gls</span>(Testisweight ~<span class="st"> </span>DML *<span class="st"> </span>fMONTH,
              <span class="dt">weights =</span> vf3,<span class="dt">data=</span>Squid)

vf4 &lt;-<span class="st"> </span><span class="kw">varPower</span>(<span class="dt">form=</span>~<span class="st"> </span>DML |<span class="st"> </span>fMONTH)
M.gls4&lt;-<span class="kw">gls</span>(Testisweight ~<span class="st"> </span>DML *<span class="st"> </span>fMONTH, <span class="dt">data =</span> Squid,
              <span class="dt">weights =</span> vf4)


vf5 &lt;-<span class="st"> </span><span class="kw">varExp</span>(<span class="dt">form =</span>~<span class="st"> </span>DML)
M.gls5 &lt;-<span class="st"> </span><span class="kw">gls</span>(Testisweight ~<span class="st"> </span>DML *<span class="st"> </span>fMONTH,
              <span class="dt">weights =</span> vf5, <span class="dt">data =</span> Squid)


vf6&lt;-<span class="kw">varConstPower</span>(<span class="dt">form =</span>~<span class="st"> </span>DML)
M.gls6&lt;-<span class="kw">gls</span>(Testisweight ~<span class="st"> </span>DML *<span class="st"> </span>fMONTH,
            <span class="dt">weights =</span> vf6, <span class="dt">data =</span> Squid)


vf7 &lt;-<span class="st"> </span><span class="kw">varConstPower</span>(<span class="dt">form =</span>~<span class="st"> </span>DML |<span class="st"> </span>fMONTH)
M.gls7&lt;-<span class="kw">gls</span>(Testisweight ~<span class="st"> </span>DML *<span class="st"> </span>fMONTH,
              <span class="dt">weights =</span> vf7, <span class="dt">data =</span> Squid)

vf8 &lt;-<span class="st"> </span><span class="kw">varComb</span>(<span class="kw">varIdent</span>(<span class="dt">form=</span> ~<span class="st"> </span><span class="dv">1</span> |<span class="st"> </span>fMONTH) ,
                 <span class="kw">varExp</span>(<span class="dt">form =</span>~<span class="st"> </span>DML) )
M.gls8&lt;-<span class="kw">gls</span>(Testisweight ~<span class="st"> </span>DML *<span class="st"> </span>fMONTH,
              <span class="dt">weights =</span> vf8, <span class="dt">data =</span> Squid)

<span class="kw">anova</span>(M.lm,M.gls1,M.gls2,M.gls3,M.gls4,
        M.gls5,M.gls6,M.gls7,M.gls8)</code></pre></div>
<pre><code>##        Model df      AIC      BIC    logLik   Test   L.Ratio p-value
## M.lm       1 25 3752.084 3867.385 -1851.042                         
## M.gls1     2 25 3620.898 3736.199 -1785.449                         
## M.gls2     3 36 3614.436 3780.469 -1771.218 2 vs 3  28.46162  0.0027
## M.gls3     4 26 3473.019 3592.932 -1710.509 3 vs 4 121.41700  &lt;.0001
## M.gls4     5 37 3407.511 3578.156 -1666.755 4 vs 5  87.50799  &lt;.0001
## M.gls5     6 26 3478.152 3598.066 -1713.076 5 vs 6  92.64159  &lt;.0001
## M.gls6     7 27 3475.019 3599.544 -1710.509 6 vs 7   5.13372  0.0235
## M.gls7     8 49 3431.511 3657.501 -1666.755 7 vs 8  87.50783  &lt;.0001
## M.gls8     9 37 3414.817 3585.463 -1670.409 8 vs 9   7.30654  0.8367</code></pre>
<p>Ooh la la looks like varPower(form=~ DML | fMONTH) is the best model</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">anova</span>(M.lm,M.gls4)</code></pre></div>
<pre><code>##        Model df      AIC      BIC    logLik   Test  L.Ratio p-value
## M.lm       1 25 3752.084 3867.385 -1851.042                        
## M.gls4     2 37 3407.511 3578.156 -1666.755 1 vs 2 368.5728  &lt;.0001</code></pre>
<p>Let’s graphically confirm.</p>
<p>First look at ordinary residuals</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">E1 &lt;-<span class="st"> </span><span class="kw">resid</span>(M.gls4)
<span class="kw">coplot</span>(E1 ~<span class="st"> </span>DML |<span class="st"> </span>fMONTH,<span class="dt">ylab=</span><span class="st">&quot;Ordinary residuals&quot;</span>,
      <span class="dt">data =</span> Squid)</code></pre></div>
<p><img src="images/03-C/unnamed-chunk-15-1.png" width="672" /></p>
<p>Turns out we should actually look at normalized residuals for model validation. Calculate the observed minus the fitted values and then divide by the square root of the variance. There shouldn’t be any heteroskedasticity.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">E2 &lt;-<span class="st"> </span><span class="kw">resid</span>(M.gls4, <span class="dt">type =</span> <span class="st">&quot;normalized&quot;</span>)
<span class="kw">coplot</span>(E2 ~<span class="st"> </span>DML |<span class="st"> </span>fMONTH, <span class="dt">data =</span> Squid,
       <span class="dt">ylab =</span> <span class="st">&quot;Normalised residuals&quot;</span>)</code></pre></div>
<p><img src="images/03-C/unnamed-chunk-16-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">anova</span>(M.gls4)</code></pre></div>
<pre><code>## Denom. DF: 744 
##             numDF   F-value p-value
## (Intercept)     1 1920.1217  &lt;.0001
## DML             1 1023.5976  &lt;.0001
## fMONTH         11   71.0854  &lt;.0001
## DML:fMONTH     11   23.9790  &lt;.0001</code></pre>
<p>Some notes for picking var functions from the book:</p>
<ul>
<li>If the variance covariate is a nominal variable use varIdent.</li>
<li>varFixed assumes that the variance of the residuals is linearly related to a variance covariate.</li>
<li>varPower should not be used if the variance covariate takes the value of zero.</li>
</ul>
<p>If you want more!</p>
</div>
<div id="second-example-benthic-biodiversity-in-nutrient-amended-tanks" class="section level4">
<h4>Second example: Benthic Biodiversity in nutrient amended tanks</h4>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Biodiversity &lt;-<span class="st"> </span><span class="kw">read.table</span>(<span class="dt">file =</span> <span class="st">&quot;data/Biodiversity.txt&quot;</span>, <span class="dt">header =</span> <span class="ot">TRUE</span>, <span class="dt">dec=</span><span class="st">&quot;,&quot;</span>) 
<span class="kw">source</span>(<span class="st">&quot;code/HighstatLibV10.R&quot;</span>)

<span class="kw">library</span>(nlme)</code></pre></div>
<pre><code>## &#39;data.frame&#39;:    108 obs. of  9 variables:
##  $ MU           : int  1 1 1 2 2 2 3 3 3 4 ...
##  $ Mesocosm     : int  1 1 1 2 2 2 3 3 3 4 ...
##  $ Abundance    : int  0 0 0 4 4 4 8 8 8 8 ...
##  $ Biomass      : num  0 0 0 0.5 0.5 0.5 1 1 1 1 ...
##  $ Treatment    : Factor w/ 2 levels &quot;Algae&quot;,&quot;NoAlgae&quot;: 2 2 2 2 2 2 2 2 2 2 ...
##  $ Nutrient     : Factor w/ 3 levels &quot;NH4&quot;,&quot;NO3&quot;,&quot;PO3&quot;: 2 2 2 2 2 2 2 2 2 2 ...
##  $ Concentration: num  2.49 1.18 3.83 3.04 2.19 ...
##  $ fTreatment   : Factor w/ 2 levels &quot;Algae&quot;,&quot;NoAlgae&quot;: 2 2 2 2 2 2 2 2 2 2 ...
##  $ fNutrient    : Factor w/ 3 levels &quot;NH4&quot;,&quot;NO3&quot;,&quot;PO3&quot;: 2 2 2 2 2 2 2 2 2 2 ...</code></pre>
<p><img src="images/03-C/unnamed-chunk-19-1.png" width="672" /><img src="images/03-C/unnamed-chunk-19-2.png" width="672" /></p>
<p><strong>Create several models with different variance covariates</strong></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(nlme)

M0&lt;-<span class="kw">gls</span>(Concentration~Biomass*fTreatment*fNutrient, ## linear model without any variance covariates
      <span class="dt">data =</span> Biodiv)
M1A&lt;-<span class="kw">gls</span>(Concentration~Biomass*fTreatment*
<span class="st">    </span>fNutrient,<span class="dt">weights=</span><span class="kw">varIdent</span>(
    <span class="dt">form=</span>~<span class="dv">1</span>|fTreatment*fNutrient),
    <span class="dt">data =</span> Biodiv) ## just one variance covariate per nutrient enrichment combination
M1B&lt;-<span class="kw">gls</span>(Concentration~Biomass*fTreatment*
<span class="st">    </span>fNutrient,
    <span class="dt">weights=</span><span class="kw">varIdent</span>(<span class="dt">form=</span>~<span class="dv">1</span>|fNutrient),
    <span class="dt">data=</span>Biodiv) ## Nutrient covariates
M1C&lt;-<span class="kw">gls</span>(Concentration~Biomass*fTreatment*
<span class="st">    </span>fNutrient,
    <span class="dt">weights=</span><span class="kw">varIdent</span>(<span class="dt">form=</span>~<span class="dv">1</span>|fTreatment),
    <span class="dt">data =</span> Biodiv) ## Enrichment covariates


<span class="kw">anova</span>(M0,M1A,M1B,M1C)</code></pre></div>
<pre><code>##     Model df      AIC      BIC    logLik   Test   L.Ratio p-value
## M0      1 13 534.5203 567.8569 -254.2602                         
## M1A     2 18 330.1298 376.2881 -147.0649 1 vs 2 214.39054  &lt;.0001
## M1B     3 15 380.0830 418.5482 -175.0415 2 vs 3  55.95320  &lt;.0001
## M1C     4 14 439.7639 475.6647 -205.8819 3 vs 4  61.68087  &lt;.0001</code></pre>
<p>Looks like <code>varIdent</code> is best because nominal variables are important</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">anova</span>(M1A)</code></pre></div>
<pre><code>## Denom. DF: 96 
##                              numDF   F-value p-value
## (Intercept)                      1 205.73777  &lt;.0001
## Biomass                          1   1.22179  0.2718
## fTreatment                       1  14.62897  0.0002
## fNutrient                        2   1.57754  0.2118
## Biomass:fTreatment               1   0.26657  0.6068
## Biomass:fNutrient                2   4.17802  0.0182
## fTreatment:fNutrient             2 121.57149  &lt;.0001
## Biomass:fTreatment:fNutrient     2   1.09043  0.3402</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(M1A)</code></pre></div>
<pre><code>## Generalized least squares fit by REML
##   Model: Concentration ~ Biomass * fTreatment * fNutrient 
##   Data: Biodiv 
##        AIC      BIC    logLik
##   330.1298 376.2881 -147.0649
## 
## Variance function:
##  Structure: Different standard deviations per stratum
##  Formula: ~1 | fTreatment * fNutrient 
##  Parameter estimates:
## NoAlgae*NO3   Algae*NO3 NoAlgae*NH4   Algae*NH4 NoAlgae*PO3   Algae*PO3 
##   1.0000000   0.5722142   1.4163868   9.4464102   0.4997455   1.2528435 
## 
## Coefficients:
##                                             Value Std.Error   t-value
## (Intercept)                             13.732722  3.036860  4.522014
## Biomass                                  2.048667  2.551473  0.802935
## fTreatmentNoAlgae                      -13.249694  3.070807 -4.314727
## fNutrientNO3                           -13.626056  3.042426 -4.478681
## fNutrientPO3                           -11.498913  3.063452 -3.753580
## Biomass:fTreatmentNoAlgae               -1.447933  2.579994 -0.561216
## Biomass:fNutrientNO3                    -2.043667  2.556149 -0.799510
## Biomass:fNutrientPO3                    -1.862453  2.573815 -0.723616
## fTreatmentNoAlgae:fNutrientNO3          16.022361  3.093064  5.180093
## fTreatmentNoAlgae:fNutrientPO3          11.430101  3.101272  3.685617
## Biomass:fTreatmentNoAlgae:fNutrientNO3   0.846933  2.598694  0.325907
## Biomass:fTreatmentNoAlgae:fNutrientPO3   1.522827  2.605590  0.584446
##                                        p-value
## (Intercept)                             0.0000
## Biomass                                 0.4240
## fTreatmentNoAlgae                       0.0000
## fNutrientNO3                            0.0000
## fNutrientPO3                            0.0003
## Biomass:fTreatmentNoAlgae               0.5760
## Biomass:fNutrientNO3                    0.4260
## Biomass:fNutrientPO3                    0.4711
## fTreatmentNoAlgae:fNutrientNO3          0.0000
## fTreatmentNoAlgae:fNutrientPO3          0.0004
## Biomass:fTreatmentNoAlgae:fNutrientNO3  0.7452
## Biomass:fTreatmentNoAlgae:fNutrientPO3  0.5603
## 
##  Correlation: 
##                                        (Intr) Biomss fTrtNA fNtNO3 fNtPO3
## Biomass                                -0.840                            
## fTreatmentNoAlgae                      -0.989  0.831                     
## fNutrientNO3                           -0.998  0.839  0.987              
## fNutrientPO3                           -0.991  0.833  0.980  0.990       
## Biomass:fTreatmentNoAlgae               0.831 -0.989 -0.840 -0.829 -0.824
## Biomass:fNutrientNO3                    0.839 -0.998 -0.829 -0.840 -0.831
## Biomass:fNutrientPO3                    0.833 -0.991 -0.824 -0.831 -0.840
## fTreatmentNoAlgae:fNutrientNO3          0.982 -0.825 -0.993 -0.984 -0.973
## fTreatmentNoAlgae:fNutrientPO3          0.979 -0.823 -0.990 -0.977 -0.988
## Biomass:fTreatmentNoAlgae:fNutrientNO3 -0.825  0.982  0.834  0.826  0.818
## Biomass:fTreatmentNoAlgae:fNutrientPO3 -0.823  0.979  0.832  0.821  0.830
##                                        Bm:TNA B:NNO3 B:NPO3 fTNA:NN
## Biomass                                                            
## fTreatmentNoAlgae                                                  
## fNutrientNO3                                                       
## fNutrientPO3                                                       
## Biomass:fTreatmentNoAlgae                                          
## Biomass:fNutrientNO3                    0.987                      
## Biomass:fNutrientPO3                    0.980  0.990               
## fTreatmentNoAlgae:fNutrientNO3          0.834  0.826  0.818        
## fTreatmentNoAlgae:fNutrientPO3          0.832  0.821  0.830  0.983 
## Biomass:fTreatmentNoAlgae:fNutrientNO3 -0.993 -0.984 -0.973 -0.840 
## Biomass:fTreatmentNoAlgae:fNutrientPO3 -0.990 -0.977 -0.988 -0.826 
##                                        fTNA:NP B:TNA:NN
## Biomass                                                
## fTreatmentNoAlgae                                      
## fNutrientNO3                                           
## fNutrientPO3                                           
## Biomass:fTreatmentNoAlgae                              
## Biomass:fNutrientNO3                                   
## Biomass:fNutrientPO3                                   
## fTreatmentNoAlgae:fNutrientNO3                         
## fTreatmentNoAlgae:fNutrientPO3                         
## Biomass:fTreatmentNoAlgae:fNutrientNO3 -0.826          
## Biomass:fTreatmentNoAlgae:fNutrientPO3 -0.840   0.983  
## 
## Standardized residuals:
##        Min         Q1        Med         Q3        Max 
## -2.2905730 -0.5536841 -0.2296708  0.5618761  3.8825074 
## 
## Residual standard error: 0.7396985 
## Degrees of freedom: 108 total; 96 residual</code></pre>
<p><strong>Drop the three-way interaction term</strong></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">M2A1&lt;-<span class="kw">gls</span>(Concentration ~<span class="st"> </span>Biomass +<span class="st"> </span>fTreatment +
<span class="st">           </span>fNutrient +
<span class="st">           </span>Biomass:fTreatment +
<span class="st">           </span>Biomass:fNutrient +
<span class="st">           </span>fTreatment:fNutrient +
<span class="st">           </span>Biomass:fTreatment:fNutrient,
           <span class="dt">weights =</span> <span class="kw">varIdent</span>(<span class="dt">form =</span>~<span class="st"> </span><span class="dv">1</span> |<span class="st"> </span>fTreatment *
<span class="st">                                         </span>fNutrient),
           <span class="dt">method =</span> <span class="st">&quot;ML&quot;</span>, <span class="dt">data =</span> Biodiv)

M2A2&lt;-<span class="kw">gls</span>(Concentration ~<span class="st"> </span>Biomass +<span class="st"> </span>fTreatment +
<span class="st">           </span>Nutrient +
<span class="st">           </span>Biomass:fTreatment +
<span class="st">           </span>Biomass:fNutrient +
<span class="st">           </span>fTreatment:fNutrient,
           <span class="dt">weights=</span><span class="kw">varIdent</span>(<span class="dt">form =</span>~<span class="st"> </span><span class="dv">1</span> |
<span class="st">                                      </span>fTreatment*
<span class="st">                                      </span>fNutrient),
          <span class="dt">method=</span><span class="st">&quot;ML&quot;</span>, <span class="dt">data =</span> Biodiv)

<span class="kw">anova</span>(M2A1,M2A2)</code></pre></div>
<pre><code>##      Model df      AIC      BIC    logLik   Test  L.Ratio p-value
## M2A1     1 18 321.0648 369.3432 -142.5324                        
## M2A2     2 16 319.4653 362.3794 -143.7327 1 vs 2 2.400507  0.3011</code></pre>
<p><strong>Next, assess the significance of all three of the two-way interactions using ANOVAs</strong></p>
<p><em>Drop Biomass:Treatment</em></p>
<pre><code>##          Model df      AIC      BIC    logLik   Test L.Ratio p-value
## M3.Full      1 16 319.4653 362.3794 -143.7327                       
## M3.Drop1     2 15 319.3730 359.6050 -144.6865 1 vs 2 1.90768  0.1672</code></pre>
<p><em>Drop Biomass:Nutrient</em></p>
<pre><code>##          Model df      AIC      BIC    logLik   Test  L.Ratio p-value
## M3.Full      1 16 319.4653 362.3794 -143.7327                        
## M3.Drop2     2 14 323.2165 360.7664 -147.6083 1 vs 2 7.751179  0.0207</code></pre>
<p><em>Drop Treatment:Nutrient</em></p>
<pre><code>##          Model df      AIC      BIC    logLik   Test  L.Ratio p-value
## M3.Full      1 16 319.4653 362.3794 -143.7327                        
## M3.Drop3     2 14 403.3288 440.8786 -187.6644 1 vs 2 87.86346  &lt;.0001</code></pre>
<p>Conclusion: drop Biomass:fTreatment</p>
<p><strong>Alternative coding</strong></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fFull&lt;-<span class="kw">formula</span>(Concentration~Biomass+fTreatment+fNutrient+
<span class="st">          </span>Biomass:fTreatment+
<span class="st">          </span>Biomass:fNutrient+
<span class="st">          </span>fTreatment:fNutrient)
          
M3.Full&lt;-<span class="kw">gls</span>(fFull,
          <span class="dt">weights=</span>vfOptim,
          <span class="dt">method=</span><span class="st">&quot;ML&quot;</span>,<span class="dt">data=</span>Biodiv)


<span class="co">#Drop Biomass:fTreatment</span>
M3.Drop1&lt;-<span class="kw">update</span>(M3.Full,.~.-Biomass:fTreatment)
<span class="kw">anova</span>(M3.Full,M3.Drop1)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#Drop Biomass:fNutrient</span>
M3.Drop2&lt;-<span class="kw">update</span>(M3.Full,.~.-Biomass:fNutrient)
<span class="kw">anova</span>(M3.Full,M3.Drop2)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#fTreatment:fNutrient</span>
M3.Drop3&lt;-<span class="kw">update</span>(M3.Full,.~.-fTreatment:fNutrient)
<span class="kw">anova</span>(M3.Full,M3.Drop3)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">##Full model
M4.Full&lt;-<span class="kw">gls</span>(Concentration~Biomass+fTreatment+fNutrient+
<span class="st">          </span>Biomass:fNutrient+
<span class="st">          </span>fTreatment:fNutrient,
          <span class="dt">weights=</span>vfOptim,
          <span class="dt">method=</span><span class="st">&quot;ML&quot;</span>,<span class="dt">data=</span>Biodiv)

<span class="co">#Drop Biomass:fNutrient</span>
M4.Drop1 &lt;-<span class="st"> </span><span class="kw">update</span>(M4.Full, .~. -Biomass:fNutrient )
<span class="kw">anova</span>(M4.Full,M4.Drop1)

<span class="co">#Drop fTreatment:fNutrient</span>
M4.Drop2 &lt;-<span class="st"> </span><span class="kw">update</span>(M4.Full, .~. -fTreatment:fNutrient )
<span class="kw">anova</span>(M4.Full,M4.Drop2)</code></pre></div>
<p><strong>Continue dropping variables</strong></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">M5.Full&lt;-<span class="kw">gls</span>(Concentration~Biomass+fTreatment+fNutrient+
<span class="st">          </span>fTreatment:fNutrient,
          <span class="dt">weights=</span>vfOptim,
          <span class="dt">method=</span><span class="st">&quot;ML&quot;</span>,<span class="dt">data=</span>Biodiv)

<span class="co">#Drop fTreatment:fNutrient</span>
M5.Drop1 &lt;-<span class="st"> </span><span class="kw">update</span>(M5.Full, .~. -fTreatment:fNutrient)
<span class="kw">anova</span>(M5.Full,M5.Drop1)</code></pre></div>
<pre><code>##          Model df      AIC      BIC    logLik   Test  L.Ratio p-value
## M5.Full      1 13 321.7872 356.6549 -147.8936                        
## M5.Drop1     2 11 406.7950 436.2985 -192.3975 1 vs 2 89.00786  &lt;.0001</code></pre>
<p><strong>Drop Biomass</strong></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">M5.Drop2 &lt;-<span class="st"> </span><span class="kw">update</span>(M5.Full, .~. -Biomass)
<span class="kw">anova</span>(M5.Full,M5.Drop2)</code></pre></div>
<pre><code>##          Model df      AIC      BIC    logLik   Test  L.Ratio p-value
## M5.Full      1 13 321.7872 356.6549 -147.8936                        
## M5.Drop2     2 12 321.2595 353.4450 -148.6297 1 vs 2 1.472279   0.225</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#New full model</span>
M6.Full&lt;-<span class="kw">gls</span>(Concentration~fTreatment+fNutrient+
<span class="st">          </span>fTreatment:fNutrient,
          <span class="dt">weights=</span>vfOptim,
          <span class="dt">method=</span><span class="st">&quot;ML&quot;</span>,<span class="dt">data=</span>Biodiv)

M6.Drop1 &lt;-<span class="st"> </span><span class="kw">update</span>(M6.Full, .~. -fTreatment:fNutrient)
<span class="kw">anova</span>(M6.Full,M6.Drop1)</code></pre></div>
<pre><code>##          Model df      AIC      BIC    logLik   Test  L.Ratio p-value
## M6.Full      1 12 321.2595 353.4450 -148.6297                        
## M6.Drop1     2 10 406.0323 432.8536 -193.0161 1 vs 2 88.77283  &lt;.0001</code></pre>
<div id="the-aftermath" class="section level5">
<h5>The aftermath</h5>
<p>Final model after insignificant variables are dropped</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">MFinal&lt;-<span class="kw">gls</span>(Concentration~fTreatment+fNutrient+
<span class="st">          </span>fTreatment:fNutrient,
          <span class="dt">weights=</span>vfOptim,
          <span class="dt">method=</span><span class="st">&quot;REML&quot;</span>,<span class="dt">data=</span>Biodiv)


E&lt;-<span class="kw">resid</span>(MFinal,<span class="dt">type=</span><span class="st">&quot;normalized&quot;</span>)
Fit=<span class="kw">fitted</span>(MFinal)

op&lt;-<span class="kw">par</span>(<span class="dt">mfrow=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))
<span class="kw">plot</span>(<span class="dt">x=</span>Fit,<span class="dt">y=</span>E,<span class="dt">xlab=</span><span class="st">&quot;Fitted values&quot;</span>,<span class="dt">ylab=</span><span class="st">&quot;Residuals&quot;</span>,
<span class="dt">main=</span><span class="st">&quot;Residuals versus fitted values&quot;</span>)
<span class="co">#identify(Fit,E)</span>
<span class="kw">hist</span>(E,<span class="dt">nclass=</span><span class="dv">15</span>)</code></pre></div>
<p><img src="images/03-C/unnamed-chunk-34-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">par</span>(op)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(MFinal)</code></pre></div>
<pre><code>## Generalized least squares fit by REML
##   Model: Concentration ~ fTreatment + fNutrient + fTreatment:fNutrient 
##   Data: Biodiv 
##        AIC      BIC    logLik
##   327.9174 359.4171 -151.9587
## 
## Variance function:
##  Structure: Different standard deviations per stratum
##  Formula: ~1 | fTreatment * fNutrient 
##  Parameter estimates:
## NoAlgae*NO3   Algae*NO3 NoAlgae*NH4   Algae*NH4 NoAlgae*PO3   Algae*PO3 
##   1.0000000   0.5010466   1.3323362   8.4363584   0.4860658   1.1073351 
## 
## Coefficients:
##                                    Value Std.Error   t-value p-value
## (Intercept)                     15.78139  1.629670  9.683792       0
## fTreatmentNoAlgae              -14.69763  1.649868 -8.908365       0
## fNutrientNO3                   -15.66972  1.632542 -9.598358       0
## fNutrientPO3                   -13.36137  1.643649 -8.129088       0
## fTreatmentNoAlgae:fNutrientNO3  16.86929  1.663956 10.138067       0
## fTreatmentNoAlgae:fNutrientPO3  12.95293  1.666324  7.773353       0
## 
##  Correlation: 
##                                (Intr) fTrtNA fNtNO3 fNtPO3 fTNA:NN
## fTreatmentNoAlgae              -0.988                             
## fNutrientNO3                   -0.998  0.986                      
## fNutrientPO3                   -0.991  0.979  0.990               
## fTreatmentNoAlgae:fNutrientNO3  0.979 -0.992 -0.981 -0.971        
## fTreatmentNoAlgae:fNutrientPO3  0.978 -0.990 -0.976 -0.986  0.982 
## 
## Standardized residuals:
##        Min         Q1        Med         Q3        Max 
## -2.2062707 -0.6078788 -0.2069959  0.5250832  4.0019026 
## 
## Residual standard error: 0.8195605 
## Degrees of freedom: 108 total; 102 residual</code></pre>
<p>Explore findings graphically</p>
<p><img src="images/03-C/unnamed-chunk-36-1.png" width="672" /></p>
<p><img src="images/03-C/unnamed-chunk-37-1.png" width="672" /></p>
<p><img src="images/03-C/unnamed-chunk-38-1.png" width="672" /></p>
</div>
</div>
</div>
<div id="discussion-questions" class="section level3">
<h3>Discussion Questions</h3>
<ul>
<li>Are there other ways you deal with heterskedasticity/heterogeneity in regressions?</li>
<li>Are there faster methods for eliminating interactions and variables than shown in the text? What if you have a lot of random/explanatory variables?</li>
<li>Are there other types of heterskedasticity you deal with in your data?</li>
</ul>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
